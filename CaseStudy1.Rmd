---
title: "Case Study 1"
author: "Yucheol Shin, Tai Chowdhury, Patricia Attah"
date: "6/21/2020" 
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Prepare Data
```{r}
library(ggplot2)
library(tidyr)
library(plyr)
library(dplyr)
library(class)
library(caret)
library(e1071)
library("RColorBrewer")

beers = read.csv("C:/Users/User 1/Desktop/SMU/DS6306/CaseStudy1/Beers.csv", header = TRUE)
breweries = read.csv("C:/Users/User 1/Desktop/SMU/DS6306/CaseStudy1/Breweries.csv", header = TRUE)
```

# Number of Breweries per state
```{r}
totalState = count(breweries, State)
breweries %>% ggplot(aes(x=State, fill = State)) + geom_bar() + geom_text(aes(State, n + 1, label=n, fill = NULL), data= totalState) + ggtitle("Number of Breweries for each State") + theme(axis.text.x = element_text(angle=90, vjust=0.6))
```

# Merge two data
```{r}
colnames(beers)[5] = "Brew_ID"
fullData = merge(beers, breweries, by = "Brew_ID")
head(fullData)
```

# Missing values
```{r}
sapply(fullData, function(x) sum(is.na(x)))

cleanData = fullData %>% filter(!is.na(ABV) & !is.na(IBU))
```

# Median ABV and IBU per states
```{r}
cleanData %>% group_by(State) %>% summarize(medianABV = median(ABV), medianIBU = median(IBU), count = n())

cleanData %>% 
  group_by(State) %>% 
  summarise(medianABV = median(ABV)) %>% 
  gather(key, value, -State) %>% 
  ggplot(aes(State, value, fill = key)) + geom_bar(stat = "identity", position = "dodge") + ggtitle("Median ABV for each State") + theme(axis.text.x = element_text(angle=90, vjust=0.6))

cleanData %>% 
  group_by(State) %>% 
  summarise(medianIBU = median(IBU)) %>% 
  gather(key, value, -State) %>% 
  ggplot(aes(State, value, fill = key)) + geom_bar(stat = "identity", position = "dodge") + ggtitle("Median IBU for each State") + theme(axis.text.x = element_text(angle=90, vjust=0.6))

```
```{r}
medABV <- cleanData %>% group_by(State) %>% summarize(medianABV = median(ABV), medianIBU = median(IBU), count = n()) %>% arrange(-medianABV)
medABV <- medABV %>% select(State, medianABV)

medIBU <- cleanData %>% group_by(State) %>% summarize(medianABV = median(ABV), medianIBU = median(IBU), count = n()) %>% arrange(-medianIBU)
medIBU <- medIBU %>% select(State, medianIBU)

head(medABV)
tail(medABV)

head(medIBU)
tail(medIBU)
```


# Max ABV and IBU of state
# Which state has max ABV / IBU
```{r}
cleanData %>% group_by(State) %>% summarize(maxABV = max(ABV), maxIBU = max(IBU))

maxABV = max(cleanData$ABV)
maxIBU = max(cleanData$IBU)

cleanData %>% filter(ABV == maxABV)
cleanData %>% filter(IBU == maxIBU)

```




# Summarize ABV
```{r}
summary(cleanData$ABV)

# Histogram of ABV Percentage 
cleanData  %>% ggplot(aes(ABV*100)) + geom_histogram(fill="darkblue",color="black", binwidth= 0.375) + xlab("% Alcohol by Volume (%ABV)") + ggtitle("Distribution of Beer %ABV, Right-Skewed") 

# Box Plot
boxplot(cleanData$ABV, col='orange',main = 'Alcohol by volume')

# QQ plot for normality check
qqnorm(cleanData$ABV, pch = 1, frame = FALSE)
qqline(cleanData$ABV, col = "steelblue", lwd = 2, main = 'Alcohol by volume')

```

# Relationship between ABV and IBU
```{r}
# Scatter Plot for ABV vs IBU for each State
cleanData %>% ggplot(aes(x=IBU, y=ABV, color=State)) + geom_point()

#7 Scatter Plot for ABV vs IBU relationship
theme_set(theme_bw())  # pre-set the bw theme.
g <- ggplot(cleanData, aes(IBU, ABV, color='red'))
g + geom_point(color='blue') + 
  geom_smooth(method="lm", se=F) +
  labs(y="ABV", 
       x="IBU", 
       title="ABV vs IBU Relationship")

```


# KNN
```{r}
set.seed(4)
filterData = cleanData %>% filter(grepl("Ale", Style) | grepl("IPA", Style))
filterData$Style[grepl("Ale", filterData$Style)] = "Ale"
filterData$Style[grepl("IPA", filterData$Style)] = "IPA"
filterData$Style = as.factor(filterData$Style)

splitPerc = .70
trainIndices = sample(1:dim(filterData)[1],round(splitPerc * dim(filterData)[1]))
train = filterData[trainIndices,]
test = filterData[-trainIndices,]

classifications = knn(train[,c(4,5)],test[,c(4,5)],train$Style, prob = TRUE, k = 5)
table(test$Style,classifications)
CM = confusionMatrix(table(test$Style,classifications))
CM

```

# KNN Acuracty Check
```{r}
set.seed(4)
accs = data.frame(accuracy = numeric(90), k = numeric(90))
highAcc = 0
highK = 0
for(i in 1:90)
{
  classifications = knn(train[,c(4,5)],test[,c(4,5)],train$Style, prob = TRUE, k = i)
  table(test$Style,classifications)
  CM = confusionMatrix(table(test$Style,classifications))
  accs$accuracy[i] = CM$overall[1]
  accs$k[i] = i
  if(highAcc < accs$accuracy[i]) {
    highAcc = accs$accuracy[i]
    highK = i
  }
}
plot(accs$k,accs$accuracy, type = "l", xlab = "k")
highK
```

# KNN Cluster plot with k=3
```{r}
set.seed(4)
fit = knn(train[,c(4,5)],test[,c(4,5)],train$Style, k=3)

k3DF = data.frame(test, predicted = fit)

k3DFBoundary = data.frame(x = k3DF$ABV, 
                      y = k3DF$IBU, 
                      predicted = k3DF$predicted)

find_hull = function(df) df[chull(df$x, df$y), ]
boundary = ddply(k3DFBoundary, .variables = "predicted", .fun = find_hull)

test$Actual = as.character(test$Style)
test$Actual = paste("Actual_", test$Actual)

legends = c("Prediction" = 16, "Actual" = 17)

ggplot() + 
  geom_point(data=k3DF,aes(ABV, IBU, color=predicted, fill=predicted), size = 5) + 
  geom_polygon(data = boundary, aes(x,y, color=predicted, fill=predicted), alpha = 0.5)+
  geom_point(aes(ABV, IBU, color=Style), data=test) + ggtitle("KNN Cluster Plot with k = 3")
```

# KNN Cluster plot with k=6
```{r}
set.seed(4)
fit = knn(train[,c(4,5)],test[,c(4,5)],train$Style, k=6)

k6DF = data.frame(test, predicted = fit)

k6DFBoundary = data.frame(x = k6DF$ABV, 
                      y = k6DF$IBU, 
                      predicted = k6DF$predicted)

find_hull = function(df) df[chull(df$x, df$y), ]
boundary = ddply(k6DFBoundary, .variables = "predicted", .fun = find_hull)

test$Actual = as.character(test$Style)
test$Actual = paste("Actual_", test$Actual)

ggplot() + 
  geom_point(data=k6DF,aes(ABV, IBU, color=predicted, fill=predicted), size = 5) + 
  geom_polygon(data = boundary, aes(x,y, color=predicted, fill=predicted), alpha = 0.5)+
  geom_point(aes(ABV, IBU, color=Style), data=test) + ggtitle("KNN Cluster Plot with k = 6") 
```

# KNN Cluster Plot for American Ales
```{r}
set.seed(4)
splitPerc = .70
aleData = cleanData %>% filter(grepl("Ale", Style) & grepl("American", Style))
trainIndices = sample(1:dim(aleData)[1],round(splitPerc * dim(aleData)[1]))
trainAle = aleData[trainIndices,]
testAle = aleData[-trainIndices,]
fit = knn(trainAle[,c(4,5)],testAle[,c(4,5)],trainAle$Style, k=6)

predAleDF = data.frame(testAle, predicted = fit)

predAleBoundary = data.frame(x = predAleDF$ABV, 
                      y = predAleDF$IBU, 
                      predicted = predAleDF$predicted)

find_hull = function(df) df[chull(df$x, df$y), ]
boundary = ddply(predAleBoundary, .variables = "predicted", .fun = find_hull)

palettes = brewer.pal(n = 9, name = "Set3")
colors = c("American Amber / Red Ale" = palettes[1], "American Black Ale" = palettes[2], "American Blonde Ale" = palettes[3], "American Brown Ale" = palettes[4], "American Dark Wheat Ale" = palettes[5], "American Pale Ale (APA)" = palettes[6], "American Pale Wheat Ale" = palettes[7], "American Strong Ale" = palettes[8], "American Wild Ale" = palettes[9])
ggplot() + 
  geom_point(data=predAleDF,aes(ABV, IBU, color=predicted, fill=predicted), size = 5) + 
  geom_polygon(data = boundary, aes(x,y, color=predicted, fill=predicted), alpha = 0.5)+
  geom_point(aes(ABV, IBU, color=Style), data=testAle) + ggtitle("KNN Cluster Plot for American Ales") +     scale_color_manual(values = colors) + scale_fill_manual(values = colors)
```

# KNN Cluster Plot for IPA
```{r}
set.seed(4)
splitPerc = .70
ipaData  = cleanData %>% filter(grepl("IPA", Style))
trainIndices = sample(1:dim(ipaData)[1],round(splitPerc * dim(ipaData)[1]))
trainIPA = ipaData[trainIndices,]
testIPA = ipaData[-trainIndices,]
fit = knn(trainIPA[,c(4,5)],testIPA[,c(4,5)],trainIPA$Style, k=6)
predIpaDF = data.frame(testIPA, predicted = fit)

predIpaBoundary = data.frame(x = predIpaDF$ABV, 
                      y = predIpaDF$IBU, 
                      predicted = predIpaDF$predicted)

find_hull = function(df) df[chull(df$x, df$y), ]
boundary = ddply(predIpaBoundary, .variables = "predicted", .fun = find_hull)

colors = c("American Double / Imperial IPA" = "red", "American IPA" = "blue", "Belgian IPA" = "green", "English India Pale Ale (IPA)" = "yellow")
ggplot() + 
  geom_point(data=predIpaDF, aes(ABV, IBU, color=predicted, fill=predicted), size = 5) + 
  geom_polygon(data = boundary, aes(x,y, color=predicted, fill=predicted), alpha = 0.5)+
  geom_point(aes(ABV, IBU, color=Style), data=testIPA) + ggtitle("KNN Cluster Plot") + ggtitle("KNN Cluster Plot for IPA") +     scale_color_manual(values = colors) + scale_fill_manual(values = colors)

```

# State comparison for HighABV&IBU ALE vs. Low ABV&IBU IPA
```{r}
filterData$IBU = as.numeric(filterData$IBU)
stateData = filterData %>% filter(((ABV<0.055) & (IBU<50) & (Style=="IPA")) | ((ABV>0.055) & (IBU>50) & (Style=="Ale")))
stateData %>% ggplot(aes(x=State, fill = Style)) + geom_bar() + ggtitle("Histogram of High ABV/IBU Ale vs. Low ABV/IBU IPA for each states") 
filterData %>% ggplot(aes(x=State, fill=Style)) +geom_bar() + ggtitle("Histogram of Ale vs. IPA for each states")  + theme(axis.text.x = element_text(angle=90, vjust=0.6))
```


